<!doctype html>
<html>

<head>
    <title>Ouvidoria Demo</title>
    <link rel="icon" href="data:image/svg+xml,...">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        /* Additional Google Font inclusion if necessary */
        @import url('https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&display=swap');

        /* Using a font closer to what Apple might use, such as Helvetica Neue */
        body, html {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: #fafafa; /* Overall background */
            margin: 0; /* Reset default margin */
        }

        .container-fluid {
            padding: 20px; /* Adds space around the content */
            margin: 20px auto 40px; /* Adds a bottom margin of 40px */
            border: 1px solid #e0e0e0; /* Thin border for the whole page */
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05); /* Soft shadow for depth */
            /* Adjust the max-width to better fit the content */
            max-width: 90%; /* Or you can set a fixed value like '1200px' */
        }

        /* Additions for a clean line-grid look */
        .table-responsive {
            border: 1px solid #e0e0e0; /* Clean table border */
        }

        .table thead th {
            background-color: #f0f0f0; /* Slight color for headers */
            border-bottom: 2px solid #e0e0e0; /* Defined line for header separation */
        }

        .table tbody tr:nth-of-type(odd) {
            background-color: #ffffff; /* Alternating row colors for readability */
        }

        .table tbody tr:nth-of-type(even) {
            background-color: #f9f9f9;
        }

        /* Row hover effect for interactivity */
        .table tbody tr:hover {
            background-color: #eef2f7;
        }

        .column-border {
            border-right: 1px solid #e0e0e0;
        }

        #messageStream {
            background-color: #ffffff; /* Column background */
            padding: 20px;
            min-height: 100vh; /* Adjust the min-height as needed */
            max-height: 100vh; /* Set maximum height to viewport height */
            overflow-y: auto; /* Enable vertical scrolling */
        }

        .speech-balloon {
            position: relative;
            background: #ececec; /* A soft gray background */
            color: #333; /* Darker text for readability */
            border-radius: 18px; /* Smooth, rounded corners for the balloon */
            padding: 15px 20px; /* Adequate padding for content */
            margin-bottom: 20px; /* Space out balloons */
            display: block; 
            clear: both;
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }

        /* Positive and Negative background colors for speech balloons */
        .speech-balloon.positive {
            background-color: #e8f5e9; /* Light green for positive sentiment */
        }

        .speech-balloon.negative {
            background-color: #ffebee; /* Light red for negative sentiment */
        }

        .message-details {
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .message-details {
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }

        .message-detail-item {
            padding: 8px 0; /* More padding for each item */
            border-bottom: 1px solid #e6e6e6; /* Light line for each item */
        }

        .message-detail-item:last-child {
            border-bottom: none; /* No border for the last item */
        }

        .message-detail-item strong {
            font-weight: 600;
            margin-right: 5px; /* Space after the emoji */
            color: #333; /* Dark grey for text */
        }

        .message-detail-item h4 {
            margin-bottom: 10px; /* Space below the ID */
        }

        /* Animation for positive flash */
        @keyframes flashGreen {
            from { background-color: #e8f5e9; } /* Light green color */
            to { background-color: transparent; }
        }

        .flash-positive {
            animation: flashGreen 1s; /* Run animation for 1 second */
        }

        /* Animation for negative flash */
        @keyframes flashRed {
            from { background-color: #ffebee; } /* Light red color */
            to { background-color: transparent; }
        }

        .flash-negative {
            animation: flashRed 1s; /* Run animation for 1 second */
        }

        .top-departments {
            padding: 20px;
            background-color: #fff;
            border-radius: 10px;
            border: 1px solid #ddd;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            height: auto; /* Adjust height as needed */
            overflow-y: auto;
        }

        .top-departments h4 {
            margin-bottom: 15px;
        }

        .top-departments li {
            padding: 5px 0;
            border-bottom: 1px solid #e6e6e6;
        }

        .top-departments li:last-child {
            border-bottom: none;
        }

        .json-code-block {
            background-color: #f8f9fa; /* A lighter background for the code block */
            border: 1px solid #ddd; /* Border to match the message details */
            border-radius: 5px; /* Rounded corners for the code block */
            padding: 10px; /* Padding inside the code block */
            margin-top: 20px; /* Margin above the code block */
            white-space: pre-wrap; /* Ensures that the JSON is properly formatted */
            overflow-x: auto; /* Allows scrolling horizontally if the JSON is wide */
            font-family: monospace; /* Font that gives the appearance of code */
        }

        /* Style for the prompt modal body */
        .modal-body {
            position: relative;
            padding: 15px;
            max-height: 400px; /* Set a max height for scrollable content */
            overflow-y: auto; /* Allow scrolling within the modal body */
        }

        .modal-wide {
            max-width: 80%; /* Or the specific width you want */
        }

        /* Styling for the prompt text */
        .modal-body pre {
            white-space: pre-wrap; /* Wrap text to fit within the modal */
            word-break: keep-all; /* Prevents breaking words */
            background-color: #f8f9fa; /* Light background for the pre element */
            border: 1px solid #ddd; /* Light border for the pre element */
            border-radius: 5px; /* Rounded corners */
            padding: 15px; /* Padding within the pre element */
            font-size: 0.9rem; /* Smaller font size for readability */
        }

        /* Ensure the code element inherits the pre formatting */
        .modal-body code {
            background-color: inherit;
            border: none;
            padding: 0;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-3 column-border d-flex flex-column">
                <h4>Stream</h4>
                <div id="messageStream">
                    <!-- Messages will be dynamically added here -->
                </div>
                
                <!-- <h4>Chat list</h4> -->
            </div>
            <div class="col-md-6 column-border d-flex flex-column">
                <!-- Placeholder for the detailed message content -->
                <h4>Detalhamento</h4>
                <div id="messageDetails" class="message-details">
                    <!-- Details will be inserted here -->
                </div>
                <!-- New div for the JSON code block -->
                <div id="jsonCodeBlock" class="json-code-block">
                    <!-- JSON will be inserted here -->
                </div>
            </div>
            <div class="col-md-3 d-flex flex-column justify-content-between">
                <!-- Use justify-content-between to push the help box to the bottom -->
                <div>
                    <h4>Top Departments</h4>
                    <div id="topDepartments" class="top-departments">
                        <ul id="departmentList" class="list-unstyled">
                            <!-- Department list items will be inserted here -->
                        </ul>
                    </div>
                </div>
                <div>
                    <!-- Help Box Button -->
                    <button type="button" class="btn btn-info btn-sm" data-bs-toggle="modal" data-bs-target="#helpModal">
                        Help & Information
                    </button>
                </div>
                
                <!-- Help Modal -->
                <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-scrollable modal-wide">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="helpModalLabel">Platform, Model & Prompt Information</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <!-- Model Info -->
                                <p><strong>Platform: </strong><a href="https://console-openshift-console.apps.cluster-qbxx5.qbxx5.openshift.opentlc.com/k8s/ns/llms/pods"
                                        target="_blank">OpenShift Container Platform</a></p>

                                <!-- Model Info -->
                                <p><strong>Model: </strong> <a href="https://huggingface.co/tiiuae/falcon-7b-instruct"
                                        target="_blank">tiiuae/falcon-7b-instruct</a></p>
                                
                                <p><strong>Model & Platform: </strong> <a href="https://openshift-gitops-server-openshift-gitops.apps.cluster-qbxx5.qbxx5.openshift.opentlc.com/applications?showFavorites=false&proj=&sync=&autoSync=&health=&namespace=&cluster=&labels="
                                        target="_blank">Falcon on OCP - Argo</a></p>
                                        
                                <!-- Prompt Info -->
                                <p><strong>Prompt: </strong></p>
                                Given the conversation below, extract key information in a structured and concise manner. The goal is to parse out
                                identifiable details such as personal names, email addresses, phone numbers, and any specific concerns or requests
                                mentioned. This extraction should culminate in a structured JSON output that includes the following fields:
                                
                                <p>- **Name**: The name(s) of the person(s) involved.</p>
                                <p>- **Email**: Email address(es) mentioned.</p>
                                <p>- **Phone Number**: Phone number(s) provided.</p>
                                <p>- **Location**: Any specific locations mentioned in relation to the issue or service.</p>
                                <p>- **Department**: The department or organization related if specified.</p>
                                <p>- **Issue**: Brief description of the main issue(s) discussed.</p>
                                <p>- **Service**: Specific service(s) mentioned in connection with the issue.</p>
                                <p>- **Additional Information**: Any other relevant details or stakeholders mentioned.</p>
                                <p>- **Detailed Description**: A comprehensive summary of the complaint or request, including any specific outcomes
                                desired.</p>
                                
                                The response should adhere to privacy and ethical guidelines, simplifying the information while preserving its original
                                context and meaning. Assumptions beyond the provided data should be avoided.
                                
                                Conversation Transcript:
                                {conversation}
                                
                                Note: Ensure your response is concise, avoiding repetition. If similar points are made more than once, summarize them in
                                a single statement, focusing on providing a clear and structured summary of the conversation's key details.
                                
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Conversation Modal -->
                <div class="modal fade" id="conversationModal" tabindex="-1" role="dialog" aria-labelledby="conversationModalLabel"
                    aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="conversationModalLabel">Conversation Content</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <p id="conversationModalContent"></p>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <!-- <script>
        const source = new EventSource("/stream");
        source.onmessage = event => {
            const request = JSON.parse(event.data);
            console.info(request);

            // Add to message stream with speech balloon design
            $('#messageStream').prepend(`<div class="speech-balloon"><p>${request.id}</p></div>`);
        };
    </script> -->
    <script>
        const source = new EventSource("/stream");

        // Call this function whenever a new message is received
        function onNewMessageReceived(message) {
            displayChatBallon(message.id, message.sentiment_analysis, message.conversation);
            displayMessageDetails(message);
            updateTopDepartments(message.department); // Update the departments list
        }

        // Example usage: This should be inside your EventSource message event listener
        source.onmessage = event => {
            const request = JSON.parse(event.data);
            console.log(request.conversation)
            onNewMessageReceived(request);
        };

        function displayChatBallon(chatID, sentiment, conversation) {
            const sentimentClass = sentiment.includes("Negative") ? 'negative' : 'positive';
            const balloon = $(`<div class="speech-balloon ${sentimentClass}"><p>💬 ${chatID}</p></div>`);
            balloon.data('conversation', conversation); // Store the conversation in the data attribute

            balloon.on('click', function () {
                // When a balloon is clicked, display the conversation in a modal
                $('#conversationModalContent').text($(this).data('conversation'));
                $('#conversationModal').modal('show');
            });

            $('#messageStream').prepend(balloon);
        }

        function displayMessageDetails(message) {

            // Construct the HTML for the message details

            const detailsHtml = `
                <div class="message-detail-item"><h4>${message.id}</h4></div>
                <div class="message-detail-item"><strong>🧑‍💼 Name:</strong> ${message.name}</div>
                <div class="message-detail-item"><strong>📧 Email:</strong> ${message.email}</div>
                <div class="message-detail-item"><strong>📞 Phone Number:</strong> ${message.phone_number}</div>
                <div class="message-detail-item"><strong>🏢 Department:</strong> ${message.department}</div>
                <div class="message-detail-item"><strong>📄 Issue:</strong> ${message.issue}</div>
                <div class="message-detail-item"><strong>🛠 Service:</strong> ${message.service}</div>
                <div class="message-detail-item"><strong>ℹ️ Additional Information:</strong> ${message.additional_information}</div>
                <div class="message-detail-item"><strong>🗒 Detailed Description:</strong> ${message.detailed_description}</div>
            `;

            // Update the message details as before
            $('#messageDetails').html(detailsHtml)
                .addClass(message.sentiment_analysis.includes("Negative") ? 'flash-negative' : 'flash-positive')
                .on('animationend', function () {
                    $(this).removeClass('flash-negative flash-positive');
                });

            // Format the JSON string to display it pretty-printed
            const jsonPretty = JSON.stringify(message, null, 4); // Indent with 4 spaces

            // Set the JSON to the code block, wrapped in <pre> and <code> for formatting
            $('#jsonCodeBlock').html(`<pre><code>${jsonPretty}</code></pre>`);
        }

        // Object to hold department counts
        const departmentCounts = {};

        function updateTopDepartments(department) {
            // Increase the count for the department or add it if it doesn't exist
            if (departmentCounts[department]) {
                departmentCounts[department]++;
            } else {
                departmentCounts[department] = 1;
            }

            // Sort departments by count
            const sortedDepartments = Object.entries(departmentCounts).sort((a, b) => b[1] - a[1]);

            // Update the list in the DOM
            const departmentListHtml = sortedDepartments.map(([dept, count]) =>
                `<li>${dept}: ${count}</li>`
            ).join('');

            $('#departmentList').html(departmentListHtml);
        }

        // $(document).ready(function () {

        //     function generateMockMessage() {
        //         // Simulate a message with a random ID
        //         const mockMessage = {
        //             id: `ID-${Math.floor(Math.random() * 1000)}`
        //         };

        //         displayChatBallon(mockMessage.id)
        //     }

        //     // Existing mock message generation code...
        //     function generateMockMessageDetails() {
        //         return {
        //             id: `ID-${Math.floor(Math.random() * 1000)}`,
        //             name: "Ana Silva",
        //             email: "ana.silva@email.com",
        //             phone_number: "(11) 99999-8888",
        //             department: "Departamento de Trânsito",
        //             issue: "Manifestação sobre a demora na manutenção de semáforos na Avenida Paulista",
        //             service: "Manutenção de semáforos",
        //             additional_information: "Manutenção de semáforos na Avenida Paulista",
        //             detailed_description: "Manifestação sobre a urgência na manutenção de semáforos na Avenida Paulista, causada por congestionamentos e acidentes.",
        //             sentiment_analysis: "The sentiment of the text is \"Negative\". This can be inferred from the mention of the \"congestion and accidents\" causing the maintenance of the semaphore, which implies a negative impact on the situation."
        //         };
        //     }

        //     // Simulate receiving a new message every 5 seconds and display its details
        //     setInterval(generateMockMessage, 10000);
        //     setInterval(function () {
        //         const newMessage = generateMockMessageDetails(); // Use the mock function to generate a new message
        //         displayMessageDetails(newMessage);
        //     }, 10000);

        // });
    </script>
</body>

</html>